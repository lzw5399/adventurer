image: alpine:latest

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_HOST: tcp://docker:2375/

  appName: adventurer
  tag: $CI_COMMIT_SHA
  repository: $dockerhub_id/$appName
  imageName: $repository:$tag

stages:
  - build
  - test
  - deploy
  - cleanup

docker_build_and_push:
  stage: build
  image: docker:18-git
  services:
    - docker:18-dind
  script:
    - docker_build

code_quantity:
  stage: test
  #image:
  variables:
    V1: ok
  allow_failure: true
  script:
    - detect_code_quantity
  only:
    refs:
      - master

.auto_devops: &auto_devops |
  function docker_build()
  {
    docker login -u "$dockerhub_id" -p "#dockerhub_pwd"
    docker build -f Dockerfile -t $imageName .
  }

  function detect_code_quantity()
  {
    echo code_quantity done
  }

before_script:
  - *auto_devops
